<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>opencv tutorial</title>
</head>
<body>

<p id="status">OpenCV.js is loading...</p>

<div class="inputImgByUser" style="border: 2px solid black;">
    <img id="imageSrc" alt="No Image" />
    <div class="caption"> imageSrc <input type="file" id="imgInput" name="file" /></div>
    <canvas id="canvas"></canvas>
    <div class="caption">canvasOutput</div>
</div>
<br/>
<div class="templateImg" style="border: 2px solid black;">
    <img id="templateSrc" alt="No Image" />
    <div class="caption"> templateSrc <input type="file" id="templInput" name="file" /></div>
    <canvas id="template"></canvas>
    <div class="caption">templateOutput</div>
</div>
<br/>
<div style="border: 2px solid black;">
    <canvas id="rect">
        <div class="caption">rectangle into canvas</div>
    </canvas>
</div>
<button style="width: 100pt; height: 60pt;"viewImg" onclick="clickButton()">Template Matching Result</button>


<script type="text/javascript">
    // insert image into image canvas

    let imgElement = document.getElementById('imageSrc');
    let inputElement = document.getElementById('imgInput');
    inputElement.addEventListener('change', (e) => {
        imgElement.src = URL.createObjectURL(e.target.files[0]);
    }, false);

    imgElement.onload = function () {
        let mat = cv.imread(imgElement);
        cv.imshow('canvas', mat);
        mat.delete();
    };

    // insert image into template canvas\
    let templateElement = document.getElementById('templateSrc');
    let inputElement_templ = document.getElementById('templInput');
    inputElement_templ.addEventListener('change', (e) => {
        templateElement.src = URL.createObjectURL(e.target.files[0]);
    }, false);

    templateElement.onload = function () {
        let mat = cv.imread(templateElement);
        cv.imshow('template', mat);
        mat.delete();
    };

    function clickButton() {
        let src = cv.imread('canvas');
        let templ = cv.imread('template');
        let dst = new cv.Mat();
        let mask = new cv.Mat();
        cv.matchTemplate(src, templ, dst, cv.TM_CCOEFF, mask);
        let result = cv.minMaxLoc(dst, mask);
        let maxPoint = result.maxLoc;
        let color = new cv.Scalar(255, 0, 0, 255);
        let point = new cv.Point(maxPoint.x + templ.cols, maxPoint.y + templ.rows);
        cv.rectangle(src, maxPoint, point, color, 4, cv.LINE_8, 0);
        cv.imshow('rect', src);
        src.delete();
        dst.delete();
        mask.delete();
    }

    //opencv가 작동되는지
    var Module = {
        // https://emscripten.org/docs/api_reference/module.html#Module.onRuntimeInitialized
        onRuntimeInitialized() {
            document
                .getElementById('status')
                .innerHTML = 'OpenCV.js is ready.';
        }
    };
</script>
<script async="async" src="opencv.js" type="text/javascript"></script>
</body>
</html>